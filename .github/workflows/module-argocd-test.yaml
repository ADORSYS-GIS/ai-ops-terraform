name: Deploy ArgoCD to K3s with Terraform
permissions:
  contents: read

on:
  push:
    branches: 
      - '**'
  workflow_dispatch:

env:
  KUBECONFIG: ${{ github.workspace }}/.kube/config

jobs:
  deploy-argocd:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up K3s cluster
      run: |
        # Install K3s with proper configuration
        curl -sfL https://get.k3s.io | sh -
        
        # Wait for K3s to be fully ready
        sleep 30
        
        # Create kubeconfig directory and copy config
        mkdir -p ${{ github.workspace }}/.kube
        sudo cp /etc/rancher/k3s/k3s.yaml "${{ github.workspace }}/.kube/config"
        sudo chmod 644 "${{ github.workspace }}/.kube/config"
        
        # Update kubeconfig to use proper server address
        sed -i 's/127.0.0.1/localhost/g' "${{ github.workspace }}/.kube/config"
        
        # Set KUBECONFIG for subsequent steps
        echo "KUBECONFIG=${{ github.workspace }}/.kube/config" >> $GITHUB_ENV

    - name: Verify K3s installation and kubeconfig
      run: |
        # Verify kubeconfig exists and is accessible
        echo "Checking kubeconfig file:"
        ls -la "${{ github.workspace }}/.kube/config"
        
        # Verify cluster access
        kubectl cluster-info
        kubectl get nodes

    - name: Copy Kubeconfig to default location
      run: |
        mkdir -p ~/.kube
        cp "${{ github.workspace }}/.kube/config" ~/.kube/config
        chmod 644 ~/.kube/config
        echo "Copied kubeconfig to default location"

    - name: Create Terraform variables file
      run: |
        cat > variables.auto.tfvars << 'EOF'
        variable "anthropic_key" {
          default = "anthropic_dummy_key_ABC123"
        }

        variable "brave_api_key" {
          default = "brave_dummy_key_DEF456"
        }

        variable "cert_arn" {
          default = "arn:aws:acm:us-east-1:123456789012:certificate/abcdefg-hijk-lmnop-qrstuvwx"
        }

        variable "fireworks_key" {
          default = "fireworks_dummy_key_GHI789"
        }

        variable "gemini_key" {
          default = "gemini_dummy_key_JKL012"
        }

        variable "litelllm_masterkey" {
          default = "litelllm_dummy_masterkey_MNO345"
        }

        variable "oidc_kc_client_id" {
          default = "oidc_client_id_dummy_PQR678"
        }

        variable "oidc_kc_client_secret" {
          default = "oidc_client_secret_dummy_STU901"
        }

        variable "oidc_kc_issuer_url" {
          default = "https://issuer.example.com/auth/realm/dummy"
        }

        variable "openai_key" {
          default = "openai_dummy_key_VWX234"
        }

        variable "pipeline_key" {
          default = "pipeline_dummy_key_YZA567"
        }

        variable "tool_api_key" {
          default = "tool_dummy_key_BCD890"
        }

        variable "webui_secret_key" {
          default = "webui_dummy_secret_key_EFG123"
        }

        variable "zone_name" {
          default = "example.com"
        }
        EOF
                echo "Created variables.tf with dummy values"

    - name: Create provider overrides
      run: |
        cat > modules/argocd/providers_override.tf << 'EOF'
        provider "kubernetes" {
          config_path = "~/.kube/config"
        }

        provider "helm" {
          kubernetes {
            config_path = "~/.kube/config"
          }
        }
        EOF
                echo "Created providers_override.tf"

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.13.3

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v2.17.0'

    - name: Terraform Init
      run: |
        terraform init
        
    - name: Terraform Apply argocd module
      run: |
        terraform apply -target=module.argocd -auto-approve 

    - name: Verify ArgoCD installation
      run: |
        # Wait for ArgoCD pods to be ready
        kubectl wait --namespace argocd \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/name=argocd-server \
          --timeout=300s
        
        # Check ArgoCD status
        kubectl get pods -n argocd
        kubectl get svc -n argocd

    - name: Get ArgoCD admin password
      run: |
        # Retrieve initial admin password
        kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d
      continue-on-error: true  # This might not exist if password was changed
