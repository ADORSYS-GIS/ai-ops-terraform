name: AI Gateway Setup

on:
  workflow_dispatch:
  push:
    branches:
      - ai-gateway-setup

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install k3s
        run: |
          curl -sfL https://get.k3s.io | sh -
          sleep 60  # Wait for k3s to fully start

      - name: Set KUBE config
        run: |
          bash -c "mkdir -p ~/.kube && sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config && sudo chmod +r ~/.kube/config"
          bash -c 'echo "export KUBECONFIG=~/.kube/config" >> ~/.bashrc'

      - name: Install Terraform
        run: |
          wget https://releases.hashicorp.com/terraform/1.0.0/terraform_1.0.0_linux_amd64.zip
          unzip terraform_1.0.0_linux_amd64.zip
          sudo mv terraform /usr/local/bin/

      - name: Install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Install KServe
        run: bash -c 'source ~/.bashrc ; curl -s "https://raw.githubusercontent.com/kserve/kserve/release-0.15/hack/quick_install.sh" | bash'

      - name: Run Terraform init and apply
        run:  bash -c 'source ~/.bashrc ; cd ${{ github.workspace }}/tf-aigateway; terraform init ; terraform apply -auto-approve'

      - name: Check pods in redis-system namespace
        run: |
          echo "AI Gateway Resources"
          echo
          source ~/.bashrc && kubectl get all -n envoy-ai-gateway-system
          echo
          echo "Envoy Gateway Resources"
          echo
          kubectl get all -n envoy-gateway-system
          echo
          echo "Redis Resources"
          kubectl get all -n redis-system
          kubectl wait --for=condition=Ready pod -l app=redis -n redis-system --timeout=5m
